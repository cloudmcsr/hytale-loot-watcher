<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Hytale Loot Viewer</title>
    
    <link rel="icon" type="image/png" href="loot-watcher-ico.png">
    <link rel="stylesheet" href="style.css">
    
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Hytale Loot Viewer" />
    <meta property="og:description" content="View and search Hytale loot tables. See which structures generate the items you want." />
    <meta property="og:image" content="https://cloudmcsr.github.io/hytale-loot-watcher/og_image.png" />
    <meta name="twitter:card" content="summary_large_image">

    <script src="data.js"></script>
    <script src="icon_mappings.js"></script>
</head>
<body>
    <!-- Upload Overlay -->
    <div id="upload-overlay">
        <div class="upload-box">
            <h1>Hytale Loot Viewer</h1>
            <p>Drag & Drop <code>mapped_prefabs_data.json</code> here</p>
            <button class="btn-upload" onclick="document.getElementById('file-input').click()">Select File</button>
            <input type="file" id="file-input" accept=".json" hidden>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <span>Prefabs</span>
            <div>
                <button id="btn-help" class="btn-icon" title="Help" onclick="openHelp()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                </button>
                <button id="btn-open" class="btn-icon" title="Open File">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>
                </button>
            </div>
        </div>
        <div class="search-box">
            <input type="text" id="search" placeholder="Search prefabs or items...">
            <button id="search-clear" class="search-clear hidden" onclick="clearSearch()" title="Clear">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="tree-root" id="sidebar-root"></div>
        <div class="scroll-hint" style="padding: 6px 10px; font-size: 11px; color: #555; text-align: center; border-top: 1px solid #333;">Shift+Scroll for horizontal scroll</div>
    </div>

    <!-- Main View -->
    <div class="main">
        <div id="empty-state" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#444;">
            <div style="opacity: 0.2; margin-bottom: 20px;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
            </div>
            <div style="font-size: 18px; font-weight: 500;">Select a prefab to view loot tables</div>
        </div>

        <div id="content-view" class="hidden" style="height:100%; display:flex; flex-direction:column;">
            <div class="top-bar">
                <div class="prefab-title" id="view-title">Goblin_Camp_01</div>
                <div class="prefab-path" id="view-path">Prefabs/Dungeons/Goblin...</div>
                <div class="stats-bar">
                    <div class="stat-item">
                        <span class="stat-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                        </span>
                        <span class="stat-value" id="stat-chests">0</span> Chests
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                        </span>
                        <span class="stat-value" id="stat-tables">0</span> Loot Tables
                    </div>
                </div>
            </div>

            <div class="content-area" id="loot-container">
                <!-- Loot Cards Go Here -->
            </div>
        </div>
    </div>


    <!-- Help Modal -->
    <div id="help-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Loot Table Viewer</h2>
                <button class="modal-close" onclick="closeHelp()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div class="modal-body">
                <section class="help-section">
                    <h3>Quick Start</h3>
                    <ul class="help-list">
                        <li><strong>Browse:</strong> Click folders and files in the sidebar</li>
                        <li><strong>Search:</strong> Type prefab names or item IDs (auto-detects what you're searching for)</li>
                        <li><strong>Filter items:</strong> Use the search box inside each loot card</li>
                        <li><strong>Collapse sections:</strong> Click SELECTION/BUNDLE headers</li>
                        <li><strong>Copy coordinates:</strong> Click coordinate chips</li>
                    </ul>
                </section>

                <section class="help-section">
                    <h3>Understanding Loot Tables</h3>
                    <table class="help-table">
                        <tr><th>Type</th><th>Description</th></tr>
                        <tr><td><code>SELECTION (Pick N)</code></td><td>Randomly selects N items from the pool</td></tr>
                        <tr><td><code>BUNDLE (All)</code></td><td>Guarantees all items in the section</td></tr>
                        <tr><td><code>Included: [Table]</code></td><td>References another loot table</td></tr>
                        <tr><td>Yellow badges</td><td>Drop chance percentage</td></tr>
                    </table>
                </section>

                <section class="help-section">
                    <h3>Generating Data for Other Versions</h3>
                    <p class="help-desc">You can generate data for any Hytale version using the files included with the game. No coding skills required!</p>
                    
                    <h4>Step 1: Locate Assets.zip</h4>
                    <p class="help-desc">Go to your Hytale installation folder and find this file:</p>
                    <pre class="code-block"><code>.../Hytale/Install/package/latest/Assets.zip</code></pre>

                    <h4>Step 2: Extract Required Folders</h4>
                    <p class="help-desc">Open <code>Assets.zip</code> and navigate into <code>Assets/Server/</code>.</p>
                    <p class="help-desc">Extract these two folders to the same folder as this tool:</p>
                    <ul class="help-list">
                        <li><code>Prefabs</code> (contains structure data)</li>
                        <li><code>Drops/Prefabs</code> (contains loot tables)</li>
                    </ul>

                    <h4>Step 3: Run the Script</h4>
                    <p class="help-desc">Run the script below to generate a new <code>mapped_prefabs_data.json</code> file.</p>
                        <button class="code-toggle" onclick="togglePythonCode()">Show Full Source â–¼</button>
                        <pre class="code-block code-full hidden" id="python-code"><code>import json
from pathlib import Path

# Configuration - paths relative to script location
DROP_TABLES_DIR = Path("./Drops/Prefabs")
PREFABS_ROOT_DIR = Path("./Prefabs")
OUTPUT_FILE = "mapped_prefabs_data.json"

def load_loot_tables(directory):
    """Load all loot table JSON files."""
    loot_map = {}
    if not directory.exists():
        print(f"Error: {directory} not found")
        print("Extract 'Drops\\Prefabs' from Assets.zip first")
        return loot_map
    
    for file_path in directory.rglob("*.json"):
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                loot_map[file_path.stem] = json.load(f)
        except Exception as e:
            print(f"Error loading {file_path.name}: {e}")
    return loot_map

def process_prefabs(prefabs_dir, loot_tables):
    """Process all prefab files and extract chest data."""
    results = []
    used_loot_ids = set()
    
    if not prefabs_dir.exists():
        print(f"Error: {prefabs_dir} not found")
        print("Extract 'Prefabs' from Assets.zip first")
        return results, used_loot_ids
    
    for file_path in prefabs_dir.rglob("*.json"):
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                data = json.load(f)
        except:
            continue
        
        blocks = data.get("blocks")
        if not isinstance(blocks, list):
            continue
        
        rel_path = file_path.relative_to(prefabs_dir)
        prefab_info = {
            "structure_name": rel_path.parts[0] if len(rel_path.parts) > 1 else "Root",
            "prefab_name": file_path.name,
            "relative_path_from_root": str(rel_path),
            "total_chests": 0,
            "chests": []
        }
        
        for block in blocks:
            if block.get("name") == "Block_Spawner_Block":
                components = block.get("components", {}).get("Components", {})
                tier_id = components.get("BlockSpawner", {}).get("BlockSpawnerId")
                
                if tier_id:
                    used_loot_ids.add(tier_id)
                    prefab_info["chests"].append({
                        "location": {"x": block["x"], "y": block["y"], "z": block["z"]},
                        "loot_table_id": tier_id
                    })
                    prefab_info["total_chests"] += 1
        
        if prefab_info["total_chests"] > 0:
            results.append(prefab_info)
    
    return results, used_loot_ids

def main():
    print("Hytale Loot Table Extractor")
    print("=" * 40)
    print(f"Looking for: {DROP_TABLES_DIR} and {PREFABS_ROOT_DIR}")
    print()
    
    all_loot_tables = load_loot_tables(DROP_TABLES_DIR)
    print(f"Loaded {len(all_loot_tables)} loot tables")
    
    prefabs_data, used_loot_ids = process_prefabs(PREFABS_ROOT_DIR, all_loot_tables)
    print(f"Processed {len(prefabs_data)} prefabs with chests")
    
    filtered_definitions = {
        tid: all_loot_tables[tid] for tid in used_loot_ids if tid in all_loot_tables
    }
    
    output = {
        "loot_table_definitions": filtered_definitions,
        "prefabs": prefabs_data
    }
    
    print(f"Writing to {OUTPUT_FILE}...")
    with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
        json.dump(output, f, indent=2)
    
    print(f"Success! {len(prefabs_data)} structures, {len(filtered_definitions)} loot tables")

if __name__ == "__main__":
    main()</code></pre>
                </section>

                <section class="help-section">
                    <h3>Tips &amp; Tricks</h3>
                    <ul class="help-list">
                        <li>Hover over item icons for detailed tooltips</li>
                        <li>Missing icons show "?" - run <code>showMissingIconsReport()</code> in console</li>
                        <li>Press <kbd>Esc</kbd> to close this help dialog</li>
                    </ul>
                </section>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
